"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.getInputIdsFromId = getInputIdsFromId;exports.getInputsFromId = getInputsFromId;exports.useArkForm = useArkForm;var _config = require("../controllers/config.controller");
var _uuid = require("../services/utils/uuid");
var _validateInput = require("../services/validation/validateInput");
var _forms = require("../stores/forms");
var _useBus = require("./useBus");


















function useArkForm() {
  let $arkform = {
    useInput(id) {
      const $forms = (0, _forms.useArkFormStore)();
      const { type, formId, groupId, inputId } = (0, _uuid.getIdsFromId)(id);

      if (type !== "input" || !formId || !inputId) {
        throw new Error(`useInput(): Invalid ID type or structure for "${id}"`);
      }

      const form = $forms.state[formId];
      if (!form) throw new Error(`useInput(): Form "${formId}" not found for "${id}"`);

      const input = groupId ?
      form.groups?.[groupId]?.inputs?.[inputId] :
      form.inputs?.[inputId];

      if (!input) {
        throw new Error(`useInput(): Input "${inputId}" not found in form "${formId}"`);
      }

      return toRefs(input);
    },

    useForm(id) {
      const $forms = (0, _forms.useArkFormStore)();

      const { type, formId } = (0, _uuid.getIdsFromId)(id);

      if (type !== "form" || !formId) {
        throw new Error(`useForm(): Invalid ID structure for "${id}"`);
      }

      const form = $forms.state[formId];

      if (!form) {
        throw new Error(`useForm(): Form "${formId}" not found`);
      }

      const inputs = form.inputs;

      const names = computed(() => {
        return Object.entries(inputs).map(([id, input]) => {
          return {
            name: input.name,
            id: id
          };
        });
      });

      const errors = computed(() => {
        return Object.values(inputs).flatMap((input) => input.errors);
      });

      const value = computed(() => {
        const result = {};

        Object.values(inputs).forEach((input) => {
          const val = input.value ? input.value : null;

          result[input.name] = val;
        });

        return result;
      });

      const valid = computed(() => {
        if (Object.values(inputs).every((input) => !input.checked)) {
          return null;
        }

        return Object.values(inputs).every((input) => input.valid);
      });

      const validated = computed(() => {
        return valid.value ? value.value : null;
      });

      const out = {
        ...toRefs($forms.state[formId]),
        names,
        errors,
        value,
        validated,
        valid
      };

      return out;
    },

    useGroup(id) {
      const $forms = (0, _forms.useArkFormStore)();

      const { type, groupId, formId } = (0, _uuid.getIdsFromId)(id);

      if (type !== "group" || !groupId || !formId) {
        throw new Error(
          `useGroup(): Invalid ID structure for "${id}", this is not a valid group ID.`
        );
      }

      const form = $forms.state[formId];
      if (!form) {
        throw new Error(`useGroup(): Form "${formId}" not found for group "${groupId}"`);
      }

      const group = $forms.state[formId].groups[groupId];

      if (!group) {
        throw new Error(`useGroup(): Group "${groupId}" not found in form "${formId}"`);
      }

      const inputs = $forms.state[formId].groups[groupId].inputs;

      const names = computed(() => {
        return Object.values(inputs).map((input) => input.name);
      });

      const errors = computed(() => {
        return Object.values(inputs).flatMap((input) => input.errors);
      });

      const valid = computed(() => {
        if (Object.values(inputs).every((input) => !input.checked)) {
          return null;
        }

        return Object.values(inputs).every((input) => input.valid);
      });

      const value = computed(() => {
        const result = {};

        Object.values(inputs).forEach((input) => {
          result[input.name] = input.value;
        });

        return result;
      });

      const validated = computed(() => {
        return valid.value ? value.value : null;
      });

      const out = {
        ...toRefs($forms.state[formId].groups[groupId]),
        names,
        value,
        errors,
        validated,
        valid
      };

      return out;
    },

    clearInputs: (id) => {
      const bus = (0, _useBus.useBus)();

      const inputIds = getInputIdsFromId(id);

      inputIds.forEach((id) => {
        const input = $arkform.useInput(id);

        input.valid.value = null;
        input.value.value = input.default.value;

        bus.emit(`input-${id}:update`, input);
      });
    },

    clearErrors: (id) => {
      const $forms = (0, _forms.useArkFormStore)();

      const inputIds = getInputIdsFromId(id);

      inputIds.forEach((id) => {
        const input = $arkform.useInput(id);

        input.errors.value = [];
      });
    },

    reset: (id) => {
      $arkform.clearErrors(id);
      $arkform.clearInputs(id);
    },

    validate: (id) => {
      if (!id) {
        console.error(`[$arkform.validate] id is invalid (${id})`);
        return false;
      }

      const inputIds = getInputIdsFromId(id);

      let valid = true;

      inputIds.forEach((id) => {
        if (!(0, _validateInput.validateInput)({ id })) {
          valid = false;
        }
      });

      return valid;
    },

    form: {
      submit: (id) => {
        if (!id) return;

        const bus = (0, _useBus.useBus)();
        bus.emit(`form-${id}:submit`);
      }
    },

    group: {
      add: (id, clearInputs = true) => {
        const group = $arkform.useGroup(id);

        if ($arkform.validate(id)) {
          group.items.value.push(group.value.value);

          const inputIds = getInputIdsFromId(id);

          if (clearInputs) {
            inputIds.forEach((id) => {
              const input = $arkform.useInput(id);

              input.value.value = input.default.value;
            });
          }
        }
      },
      remove: (id, index) => {
        const group = $arkform.useGroup(id);
        group.items.value.splice(index, 1);
      }
    },

    config: _config.arkConfigDefaults
  };

  return $arkform;
}

function getInputsFromId(id) {
  return computed(() => {
    const $arkform = useArkForm();

    const { type, formId, groupId, inputId } = (0, _uuid.getIdsFromId)(id);

    if (type === "input" && inputId) {
      return { inputId: $arkform.useInput(inputId) };
    }

    if (groupId) {
      return $arkform.useGroup(groupId).inputs;
    }

    if (type === "form" && formId) {
      const form = $arkform.useForm(formId);

      let inputs = {
        ...$arkform.useForm(formId).inputs
      };

      if (groupId) {
        for (let [grId, input] of Object.entries(form.groups)) {
          const group = $arkform.useGroup(grId);

          inputs = {
            ...inputs,
            ...group.inputs
          };
        }
      }

      return inputs;
    }

    return {};
  });
}
function getInputIdsFromId(id) {
  const $arkform = useArkForm();

  const { type, formId, groupId, inputId } = (0, _uuid.getIdsFromId)(id);

  if (type === "input" && inputId) {
    return [inputId];
  }

  if (type === "group" && groupId) {
    return Object.keys($arkform.useGroup(groupId).inputs.value);
  }

  if (type === "form" && formId) {
    const form = $arkform.useForm(formId);

    if (!form) return [];

    let ids = [...Object.keys(form.inputs.value)];

    const groupIds = Object.keys(form.groups.value);

    groupIds.forEach((id) => {
      const group = $arkform.useGroup(id);

      ids.push(...Object.keys(group.inputs.value));
    });

    return ids;
  }

  return [];
} /* v9-1c8c7d4aa8774c37 */
